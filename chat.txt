import cv2
import numpy as np
import os
import random
from typing import List, Union

# ä¿ç•™åŸæœ‰æ‰€æœ‰å™ªéŸ³å¤„ç†å‡½æ•°...

def apply_random_effects(
    image: np.ndarray,
    num_effects: Union[int, tuple] = (1, 3),
    effect_list: List[str] = None
) -> np.ndarray:
    """å®Œå…¨éšæœºåŒ–çš„å™ªéŸ³æ•ˆæœåº”ç”¨å‡½æ•°
    :param image: è¾“å…¥å›¾åƒ(BGRæ ¼å¼)
    :param num_effects: æ¥å—intæˆ–tupleï¼Œæ§åˆ¶æ•ˆæœæ•°é‡èŒƒå›´
    :param effect_list: Noneè¡¨ç¤ºä½¿ç”¨å…¨éƒ¨æ•ˆæœ
    :return: å¤„ç†åçš„å›¾åƒ + ä½¿ç”¨çš„æ•ˆæœåç§°åˆ—è¡¨
    """
    # æ•ˆæœæ˜ å°„è¡¨
    FOREGROUND_MAPPING = {  # ç¡®ä¿åŒ…å«æ‰€æœ‰æ•ˆæœ
        'white-lines': img_white_dash,
        'vertical-lines': vertical_lines,
        'inkbleed': img_inkbleed,
        'letter-press': img_letterpress,
        'img-blur': img_blur,
        'downscale': img_downscale,
        'erode': img_erode,
        'dilate': img_dilate,
        'pixel-dropout': img_pixeldropout,
        'sharpen': img_sharpen,
        'scribbles': img_scribbles,
        'noisy-lines': img_noisy_line,
        'squish': img_squish,
        'bleedthrough': img_bleedthrough,
        'BadPhotoCopy': img_badphotocopy,
        'BrightnessTexturize': img_brightness_texturize,
        'DirtyDrum': img_dirty_drum,
        'Faxify': img_faxify,
        'Hollow': img_hollow,
        'LightingGradient': img_lighting_gradient,
        'LowLightNoise': img_low_light_noise,
        'PatternGenerator': img_pattern_generator,
        'ShadowCast': img_shadow_cast,
        'SubtleNoise': img_subtle_noise,
        'VoronoiTessellation': img_voronoi_tessellation,
        'WaterMark': img_water_mark,
        "gussis_noise": gussis_noise
    }

    # è‡ªåŠ¨ç”Ÿæˆå¯é€‰æ•ˆæœåˆ—è¡¨
    available_effects = list(FOREGROUND_MAPPING.keys())
    if effect_list:  # è¿‡æ»¤æ— æ•ˆæ•ˆæœ
        available_effects = [e for e in effect_list if e in FOREGROUND_MAPPING]

    # è®¾ç½®éšæœºæ•ˆæœæ•°é‡ (æ”¯æŒèŒƒå›´å’Œå›ºå®šå€¼)
    if isinstance(num_effects, tuple):
        min_eff = max(1, num_effects[0])
        max_eff = min(len(available_effects), num_effects[1])
        actual_num = random.randint(min_eff, max_eff)
    else:
        actual_num = min(max(1, num_effects), len(available_effects))

    # éšæœºé€‰æ‹©æ•ˆæœï¼ˆå…è®¸é‡å¤å åŠ ï¼‰
    selected_effects = random.choices(available_effects, k=actual_num)
    
    # åº”ç”¨æ•ˆæœæµç¨‹
    processed_image = image.copy()
    applied_effects = []
    
    random.shuffle(selected_effects)  # éšæœºæ‰“ä¹±åº”ç”¨é¡ºåº
    for effect_name in selected_effects:
        try:
            processed_image = FOREGROUND_MAPPING[effect_name](processed_image)
            applied_effects.append(effect_name)
        except Exception as e:
            print(f"âš ï¸ æ•ˆæœ {effect_name} åº”ç”¨å¤±è´¥: {str(e)}")
    
    return processed_image, applied_effects

def process_batch_images(
    input_dir: str,
    output_dir: str,
    num_effects_range: tuple = (1, 5),
    effect_list: List[str] = None
):
    """å…¨è‡ªåŠ¨æ‰¹é‡å¤„ç†å‡½æ•°
    :param input_dir: è¾“å…¥å›¾ç‰‡ç›®å½•
    :param output_dir: è¾“å‡ºç›®å½•(è‡ªåŠ¨åˆ›å»º)
    :param num_effects_range: æ¯å›¾åº”ç”¨çš„æ•ˆæœæ•°é‡èŒƒå›´
    :param effect_list: Noneè¡¨ç¤ºä½¿ç”¨å…¨éƒ¨æ•ˆæœ
    """
    # åˆ›å»ºè¾“å‡ºç›®å½•å¹¶éªŒè¯è¾“å…¥
    os.makedirs(output_dir, exist_ok=True)
    if not os.path.exists(input_dir):
        raise FileNotFoundError(f"è¾“å…¥ç›®å½•ä¸å­˜åœ¨: {input_dir}")

    # éå†å¤„ç†æ¯å¼ å›¾ç‰‡
    for filename in os.listdir(input_dir):
        # è¿‡æ»¤éå›¾åƒæ–‡ä»¶
        if not filename.lower().endswith(('.png', '.jpg', '.jpeg')):
            continue

        # è¯»å–å›¾åƒæ–‡ä»¶
        input_path = os.path.join(input_dir, filename)
        image = cv2.imread(input_path)
        if image is None:
            print(f"ğŸš« æ— æ³•è¯»å–å›¾åƒ: {input_path}")
            continue

        # åº”ç”¨éšæœºæ•ˆæœ
        processed_img, applied_effects = apply_random_effects(
            image,
            num_effects=num_effects_range,
            effect_list=effect_list
        )

        # ç”Ÿæˆè¾“å‡ºè·¯å¾„
        base_name = os.path.splitext(filename)[0]
        effects_str = "+".join(sorted(applied_effects))  # æ’åºä¾¿äºå¯¹æ¯”è§‚å¯Ÿ
        output_path = os.path.join(
            output_dir,
            f"{base_name}_FX[{effects_str}].jpg"  # åŒ…å«æ•ˆæœæ ‡è®°çš„æ–‡ä»¶å
        )

        # å†™å…¥å¤„ç†åçš„å›¾åƒ
        success = cv2.imwrite(output_path, processed_img)
        if success:
            print(f"âœ… å·²ä¿å­˜: {output_path}")
        else:
            print(f"âŒ ä¿å­˜å¤±è´¥: {output_path}")

if __name__ == "__main__":
    # ç¤ºä¾‹ç”¨æ³•ï¼ˆå®Œæ•´è‡ªåŠ¨åŒ–æ¨¡å¼ï¼‰
    process_batch_images(
        input_dir="åŸå§‹å›¾ç‰‡",
        output_dir="å¢å¼ºç»“æœ",
        num_effects_range=(2, 4),  # æ¯å›¾åº”ç”¨2-4ç§éšæœºæ•ˆæœ
        effect_list=None  # ä½¿ç”¨å…¨éƒ¨25ç§æ•ˆæœ
    )
