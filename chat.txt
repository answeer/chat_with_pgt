import json
import os
import pandas as pd
import streamlit as st

# Step 1: 读取JSON文件
def load_json(file_path):
    with open(file_path, 'r') as f:
        data = json.load(f)
    return data

# Step 2: 提取extracted_values.page_data.values并转换为表格
def extract_values(data):
    extracted_values = []
    for item in data['extracted_values']:
        page_data = item['page_data']
        for value in page_data['values']:
            extracted_values.append({
                'doc_id': item['doc_id'],
                'page_number': item['page_number'],
                'entity_name': value['entity_name'],
                'pred_ref_id': value['pred_ref_id'],
                'value': value['value'],
                'confidence': value['confidence']
            })
    return pd.DataFrame(extracted_values)

# Step 3: 在Streamlit中显示表格并设置可编辑列
def main():
    st.title("JSON数据处理与编辑")
    
    # 输入JSON文件路径
    file_path = st.text_input("输入JSON文件路径")
    if file_path:
        data = load_json(file_path)
        df = extract_values(data)
        
        # 定义可编辑列的选项，确保没有None值
        edit_options = ["correct_redact", "wrong_redact", "entity_not_found"]
        
        # 将 value 列转换为可选的下拉菜单类型，并避免None值
        df['value'] = pd.Categorical(df['value'], categories=edit_options, ordered=True)
        
        # 使用st.data_editor显示表格，仅允许编辑value列
        edited_df = st.data_editor(
            df, 
            num_rows="dynamic", 
            disabled=['doc_id', 'page_number', 'entity_name', 'pred_ref_id', 'confidence']
        )
        
        # 提交按钮
        if st.button("提交"):
            # 更新原始数据中的values
            for index, row in edited_df.iterrows():
                for item in data['extracted_values']:
                    if item['doc_id'] == row['doc_id'] and item['page_number'] == row['page_number']:
                        for value in item['page_data']['values']:
                            if value['pred_ref_id'] == row['pred_ref_id']:
                                value['value'] = row['value']
            
            # 获取保存路径（与输入文件同级目录）
            dir_name = os.path.dirname(file_path)
            save_path = os.path.join(dir_name, 'updated_data.json')
            
            # 保存为新的JSON文件
            with open(save_path, 'w') as f:
                json.dump(data, f, indent=4)
            st.success(f"数据已更新并保存为 {save_path}")

if __name__ == "__main__":
    main()
