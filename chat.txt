import os
import cv2
import torch
import numpy as np
import argparse
import pathlib
from tqdm import tqdm  # å¯¼å…¥è¿›åº¦æ¡åº“

from utils import util
import options.options as option
from models import create_model

import torch
from PIL import Image
import torchvision.transforms as transforms

def setup_model(opt_path):
    parser = argparse.ArgumentParser()
    parser.add_argument('--opt', type=str, default=opt_path)
    args, _ = parser.parse_known_args()  # é¿å…å¹²æ‰°ä¸»å‡½æ•°å‚æ•°è§£æ
    
    opt = option.parse(args.opt, is_train=False)
    opt['dist'] = False

    # åˆå§‹åŒ–æ¨¡å‹
    model = create_model(opt)
    
    # åŠ è½½é¢„è®­ç»ƒæƒé‡
    print("\nğŸ—œï¸ æ­£åœ¨åŠ è½½é¢„è®­ç»ƒæ¨¡å‹...")
    state_dict = torch.load(opt['path']['pretrain_model_G'])
    corrected_dict = {f"module.{k}": v for k, v in state_dict.items()}
    model.netG.load_state_dict(corrected_dict, strict=True)
    model.netG.eval()
    return model, opt

def process_batch(input_dir, output_dir, model):
    # å‡†å¤‡æ–‡ä»¶åˆ—è¡¨
    valid_ext = ('.png', '.jpg', '.jpeg', '.bmp', '.tiff')
    file_list = [f for f in os.listdir(input_dir) 
                if f.lower().endswith(valid_ext)]
    total_files = len(file_list)

    # åˆå§‹åŒ–è¿›åº¦æ¡
    progress_bar = tqdm(
        total=total_files,
        unit="å¼ ",
        desc="ğŸš€ æ­£åœ¨å¢å¼ºå›¾åƒ",
        bar_format="{l_bar}{bar}| {n_fmt}/{total_fmt} [{elapsed}<{remaining}]"
    )

    processed = 0
    errors = 0

    for filename in file_list:
        try:
            # å¤„ç†å•å¼ å›¾ç‰‡
            img_path = os.path.join(input_dir, filename)
            image = cv2.imread(img_path)
            
            if image is None:
                raise ValueError("æ— æ³•è¯»å–å›¾åƒæ–‡ä»¶")

            # å‰å¤„ç†
            rgb_img = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
            tensor_img = transforms.ToTensor()(rgb_img).unsqueeze(0)

            # æ¨ç†
            with torch.no_grad():
                enhanced = util.single_forward(model.netG, tensor_img)

            # åå¤„ç†
            output_img = util.tensor2img(enhanced)
            output_img = cv2.cvtColor(output_img, cv2.COLOR_RGB2BGR)

            # ä¿å­˜ç»“æœ
            output_path = os.path.join(output_dir, filename)
            cv2.imwrite(output_path, output_img)

            # æ›´æ–°è¿›åº¦
            processed += 1
            progress_bar.set_postfix({
                "å·²å¤„ç†": processed,
                "å¤±è´¥": errors,
                "å½“å‰æ–‡ä»¶": filename[:15] + "..." if len(filename) >15 else filename
            })
            
        except Exception as e:
            errors += 1
            print(f"\nâŒ å¤„ç†å¤±è´¥ {filename}: {str(e)}")
        finally:
            progress_bar.update(1)

    progress_bar.close()
    print(f"\nâœ… å¤„ç†å®Œæˆï¼æˆåŠŸ {processed} å¼ ï¼Œå¤±è´¥ {errors} å¼ ")

def main():
    parser = argparse.ArgumentParser(description="ğŸ—‚ï¸ å›¾åƒå¢å¼ºæ‰¹é‡å¤„ç†å™¨")
    parser.add_argument('--input_dir', required=True, help="è¾“å…¥ç›®å½•è·¯å¾„")
    parser.add_argument('--output_dir', required=True, help="è¾“å‡ºç›®å½•è·¯å¾„")
    parser.add_argument('--opt', default='./options/test.yml', help="é…ç½®æ–‡ä»¶è·¯å¾„")
    
    args = parser.parse_args()
    
    # åˆ›å»ºè¾“å‡ºç›®å½•
    os.makedirs(args.output_dir, exist_ok=True)
    
    # åˆå§‹åŒ–æ¨¡å‹
    model, _ = setup_model(args.opt)
    
    # å¼€å§‹å¤„ç†
    print(f"\nğŸ“ è¾“å…¥ç›®å½•: {args.input_dir}")
    print(f"ğŸ“‚ è¾“å‡ºç›®å½•: {args.output_dir}")
    process_batch(args.input_dir, args.output_dir, model.netG)

if __name__ == "__main__":
    main()
